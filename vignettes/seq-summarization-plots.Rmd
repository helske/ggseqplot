---
title: "Sequence Summarization Plots"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Sequence Summarization Plots}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
csl: https://www.zotero.org/styles/apa
bibliography: references.bib
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width=8, 
  fig.height=6
)
options(rmarkdown.html_vignette.check_title = FALSE)

pkgs <- c("colorspace", "ggplot2", "ggthemes", "ggseqplot", "hrbrthemes", 
          "patchwork", "TraMineR", "TraMineRextras")

# Load all packages to library and adjust options
lapply(pkgs, library, character.only = TRUE)


```

Following Fasang and Liao [-@fasang2014], we distinguish between sequence representation and summarization graphs. The latter aggregate and summarize the information stored in the sequence data without plotting actual observed sequences. Given the complexity of sequence data, theses type of plots focus on one or two dimensions of information stored in sequence data [@brzinsky-fay2014]. Among the diverse members of the family of summarization graphs are sequence transitions plot, Kaplan-Meier survival curves, modal state plots, mean time plots, state distribution plots, and entropy plots [@fasang2014; @raab2022].

Currently, `{ggseqplot}` includes three summarization graphs:

-   state distribution plots (`ggseqdplot`)
-   entropy line plots (`ggseqplot`)
-   transition rate plots (`ggseqtrplot`)

[`{TraMineR}`](http://traminer.unige.ch){target="\_blank"} and [`{TraMineRextras}`](http://traminer.unige.ch){target="\_blank"} provide a much more comprehensive set of plots. Although, {ggseqplot} does not aim at rebuilding all of these plots it's planned to add additional plot types.

This vignette outlines how sequence data generated with `TraMineR::seqdef` are reshaped to plot them as ggplot2-typed figures using {ggseqplot}. We compare the resulting plots to those produced by [`{TraMineR}`](http://traminer.unige.ch){target="\_blank"} where applicable. 

Note, that this library was not written because I personally dislike the plots produced by [`{TraMineR}`](http://traminer.unige.ch){target="\_blank"}, but rather because I am normally using [`{ggplot2}`](https://ggplot2.tidyverse.org/){target="\_blank"} instead of base R's `plot` environment for visualizing data. [`{TraMineR}`](http://traminer.unige.ch){target="\_blank"} [@gabadinho2011] was developed before [`{ggplot2}`](https://ggplot2.tidyverse.org/){target="\_blank"} [@wickham2016] was as popular as it is today and back then many users were more familiar with coding base R plots. To date, however, many researchers and students are more accustomed to using [`{ggplot2}`](https://ggplot2.tidyverse.org/){target="\_blank"} and prefer to draw on the related skills and experiences instead of learning how to refine base R plots just for the single purpose of visualizing sequence data. 

## Setup example

We start by loading the required libraries and defining the sequence data to be plotted. We draw in the examples from the [`{TraMineR}`](http://traminer.unige.ch){target="\_blank"} for setting up the examples.

\  


<details><summary>**Click to see code for installing and loading required packages**</summary>

```{r libraries, eval=FALSE}
# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# Load and download (if necessary) required packages ----
# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~


# Save package names as a vector of strings
pkgs <- c("colorspace", "ggplot2", "ggthemes", "hrbrthemes", 
          "patchwork", "TraMineR", "TraMineRextras")


# Install uninstalled packages
lapply(pkgs[!(pkgs %in% installed.packages())], 
       install.packages, repos = getOption("repos")["CRAN"])


# Load all packages to library and adjust options
lapply(pkgs, library, character.only = TRUE)

# Don't forget to load ggseqplot
library(ggseqplot)

```
</details>


\  


```{r setup, message=FALSE}


# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# Creating state sequence objects from example data sets ----
# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

# biofam data
data(biofam)

biofam.lab <- c("Parent", "Left", "Married", "Left+Marr",
                "Child", "Left+Child", "Left+Marr+Child", "Divorced")

biofam.seq <- seqdef(biofam, 10:25, 
                     labels = biofam.lab,
                     weights = biofam$wp00tbgs)

## actcal data
data(actcal)

actcal.lab <- c("> 37 hours", "19-36 hours", "1-18 hours", "no work")

actcal.seq <- seqdef(actcal,13:24,
                     labels=actcal.lab)

## ex1 data
data(ex1)
ex1.seq <- seqdef(ex1, 1:13, 
                  weights=ex1$weights)

```

Note that the default figure size in this document is specified as: 

> fig.width=8, fig.height=6


## State distribution plots

### Technicalities

Under the hood `ggseqdplot` calls `TraMineR::seqstatd` to obtain the cross-sectional state distributions across the positions of the sequence data. These distributional data are reshaped into a long data set in which every row stores the (weighted) relative frequency of a given state at a given position along the sequence. The example data `actcal.seq`, for instance,  contain sequences of length 12 with an alphabet comprising 4 states. The reshaped data serving as source for the `ggplot` thus contain $12\times4=48$ rows. If a group vector is specified, the respective data will comprise 48 rows for each group. The data set produced by `ggseqdplot` can be accessed if the function's output is assigned to an object. The resulting list object stores the data as its first element (named `data`).

```{r}
dplot <- ggseqdplot(actcal.seq)
dplot$data
```

Once the data are in the right shape `ggseqdplot` renders stacked bar charts for each sequence position using `ggplot2::geom_bar`.



### Baseline comparison

We start with the most basic version of the function simply plotting the state distributions of `actcal.seq` without changing any of the defaults. Despite a few layout differences both produce pretty similar results.


```{r, dplot1}
# TraMineR::seqplot
seqdplot(actcal.seq)

# ggseqplot::ggseqdplot
ggseqdplot(actcal.seq)
```

This similarity prevails also when we add some complexity by visualizing the state distributions by gender.

```{r}
# TraMineR::seqplot
seqdplot(actcal.seq, group=actcal$sex)

# ggseqplot::ggseqdplot
ggseqdplot(actcal.seq, group=actcal$sex)
```

### Utilizing ggplot2 environment

We proceed by illustrating how [`{ggplot2}`](https://ggplot2.tidyverse.org/){target="\_blank"} functions & extensions can be used to refine the
default outcome. Just like every other [`{ggplot2}`](https://ggplot2.tidyverse.org/){target="\_blank"} figure the appearance of plots generated with `ggseqplot` functions can be dramatically changed with a few adjustments:

```{r, message=FALSE, warning=FALSE}
ggseqdplot(actcal.seq) +
  scale_fill_discrete_sequential("heat") +
  scale_x_discrete(labels = month.abb) +
  labs(title = "State distribution plot",
       x = "Month") +
  guides(fill=guide_legend(title="Alphabet")) +
  theme_ipsum_rc() +
  theme(plot.title = element_text(size = 30, 
                                  margin=margin(0,0,20,0)),
        plot.title.position = "plot")
```

In the following example we again illustrate a few [`{ggplot2}`](https://ggplot2.tidyverse.org/){target="\_blank"} functions & extensions by composing a figure comprising two plots produced with `ggseqdplot`. Both visualize the same data but only the first plot considers weights. In addition to state distributions the plots display the accompanying entropies as line plot (`geom_line`). Finally, the plots are brought together using the [`{patchwork}`](https://patchwork.data-imaginist.com/index.html) library [@pedersen2020].


```{r, message=FALSE, warning=FALSE}
# Save plot using weights
p1 <- ggseqdplot(ex1.seq, 
                 with.entropy = TRUE) + 
  ggtitle("Weighted data")

# Save same plot without using weights
p2 <- ggseqdplot(ex1.seq, 
                 with.entropy = TRUE,
                 weighted = FALSE) + 
  ggtitle("Unweighted data")

# Arrange and refine plots using patchwork
p1 + p2 + 
  plot_layout(guides = "collect") &
  scale_fill_manual(values= canva_palettes$`Fun and tropical`[1:4]) &
  theme_ipsum_rc() &
  theme(plot.title = element_text(size = 20,
                                  hjust = 0.5),
        legend.position = "bottom",
        legend.title = element_blank())
```





## Entropy plots



## Transition rate plots

### Technicalities

\

### Examples

We start with a simple example that only takes the sequence data and the group argument as inputs. The output is a faceted plot visualizing two transition rate matrices of DSS sequence data.  

```{r}
ggseqtrplot(actcal.seq, 
            group = actcal$sex)
```

In the second example we specify additional arguments and utilize once again the `patchwork` library to compose a figure that compares the transition matrices of sequence stored in the STS and the DSS format.

We use `x_n.dodge = 2` to prevent overlapping of the state labels of the x-axis, slightly reduce the labels size of the value labels displayed within the tiles, and use `dss = FALSE` to compute and display the transition rates of the STS sequences.

```{r}

p1 <- ggseqtrplot(biofam.seq, 
                  dss = FALSE, 
                  x_n.dodge = 2,
                  labsize = 3) +
  ggtitle("STS Sequences") +
  theme(plot.margin = unit(c(5,10,5,5), "points"))

p2 <- ggseqtrplot(biofam.seq, 
                  x_n.dodge = 2,
                  labsize = 3) +
    ggtitle("DSS Sequences") +
  theme(plot.margin = unit(c(5,5,5,10), "points"))

p1 + p2 &
  theme(plot.title = element_text(size = 20,
                                  hjust = 0.5))

```

Other than the grouped version of the plot this composed figure contains the y-axis title and labels twice. This can be changed with small adjustments of the corresponding `theme` arguments. 


```{r}

p2 <- p2 +
  theme(axis.text.y = element_blank(), 
        axis.title.y = element_blank())

p1 + p2 &
  theme(plot.title = element_text(size = 20,
                                  hjust = 0.5))
```



---

## References
